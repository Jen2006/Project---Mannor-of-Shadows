{% extends "base.html" %}

{% block content %}
<style>
body::before {
    background: url('/static/images/final-room.png') center/cover no-repeat !important;
}

/* Control Room Background Effects */
.control-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: -1;
    background: 
        radial-gradient(circle at 20% 30%, rgba(255, 0, 0, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(0, 100, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(0, 255, 100, 0.1) 0%, transparent 50%);
}

.control-node {
    position: absolute;
    border-radius: 50%;
    animation: pulseNode 4s infinite;
}

@keyframes pulseNode {
    0%, 100% { transform: scale(1); opacity: 0.3; }
    50% { transform: scale(1.2); opacity: 0.6; }
}
</style>

<!-- Control Room Background -->
<div class="control-bg" id="controlBg"></div>

<div class="room control-room">
    <!-- Enhanced Header -->
    <div class="room-description">
        <div class="title-container">
            <div class="title-glow control-glow"></div>
            <h2 class="control-title">
                <span class="title-icon">üéõÔ∏è</span>
                <span class="title-word">Master</span>
                <span class="title-word">Control</span>
                <span class="title-word">Center</span>
            </h2>
        </div>
        
        <div class="description-content">
            <div class="control-panel-intro">
                <div class="panel-glow"></div>
                <p>You've reached the heart of the manor. Three critical systems need to be assigned to their technicians. Solve the logic puzzle to activate the escape mechanism.</p>
                <div class="urgency-alert">
                    <div class="alert-pulse"></div>
                    <span class="alert-icon">‚ö†Ô∏è</span>
                    <span class="alert-text">Systems must be correctly assigned to unlock the final escape</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Puzzle Area -->
    <div class="puzzle-area">
        <form method="POST" id="controlForm">
            <div class="control-container">
                <!-- Clues Section -->
                <div class="control-section clues-section">
                    <div class="section-glow control-glow"></div>
                    <div class="clues-container">
                        <div class="clues-header control-header">
                            <div class="header-orb control-orb"></div>
                            <span class="clues-icon">üîç</span>
                            <h3>Investigation Clues</h3>
                            <div class="clues-count">
                                <span class="count-badge">{{ clues|length }} Critical Clues</span>
                            </div>
                        </div>
                        
                        <div class="clues-grid">
                            {% for clue in clues %}
                            <div class="clue-card control-clue" data-clue="{{ loop.index }}">
                                <div class="clue-number">{{ loop.index }}</div>
                                <div class="clue-content">
                                    <p>{{ clue }}</p>
                                </div>
                                <div class="clue-connector"></div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Assignment Section -->
                <div class="control-section assignment-section">
                    <div class="section-glow assignment-glow"></div>
                    <div class="assignment-container">
                        <div class="assignment-header control-header">
                            <div class="header-orb assignment-orb"></div>
                            <span class="assignment-icon">üë•</span>
                            <h3>System Assignments</h3>
                            <div class="assignment-progress">
                                <span class="progress-badge">Complete All Fields</span>
                            </div>
                        </div>
                        
                        <div class="assignment-grid">
                            <!-- System Technicians -->
                            <div class="assignment-group">
                                <h4 class="group-title">
                                    <span class="title-icon">üî¥</span>
                                    System Technicians
                                </h4>
                                <div class="form-group cosmic-form-group">
                                    <label class="cosmic-label">
                                        <span class="label-icon red-glow">üî¥</span>
                                        Red System
                                    </label>
                                    <select name="red_system" class="cosmic-select" required>
                                        <option value="">Select Technician...</option>
                                        <option value="electrician">‚ö° Electrician</option>
                                        <option value="plumber">üîß Plumber</option>
                                        <option value="mechanic">üõ†Ô∏è Mechanic</option>
                                    </select>
                                    <div class="select-glow"></div>
                                </div>
                                
                                <div class="form-group cosmic-form-group">
                                    <label class="cosmic-label">
                                        <span class="label-icon blue-glow">üîµ</span>
                                        Blue System
                                    </label>
                                    <select name="blue_system" class="cosmic-select" required>
                                        <option value="">Select Technician...</option>
                                        <option value="electrician">‚ö° Electrician</option>
                                        <option value="plumber">üîß Plumber</option>
                                        <option value="mechanic">üõ†Ô∏è Mechanic</option>
                                    </select>
                                    <div class="select-glow"></div>
                                </div>
                                
                                <div class="form-group cosmic-form-group">
                                    <label class="cosmic-label">
                                        <span class="label-icon green-glow">üü¢</span>
                                        Green System
                                    </label>
                                    <select name="green_system" class="cosmic-select" required>
                                        <option value="">Select Technician...</option>
                                        <option value="electrician">‚ö° Electrician</option>
                                        <option value="plumber">üîß Plumber</option>
                                        <option value="mechanic">üõ†Ô∏è Mechanic</option>
                                    </select>
                                    <div class="select-glow"></div>
                                </div>
                            </div>

                            <!-- Technician Roles -->
                            <div class="assignment-group">
                                <h4 class="group-title">
                                    <span class="title-icon">üë§</span>
                                    Technician Roles
                                </h4>
                                <div class="form-group cosmic-form-group">
                                    <label class="cosmic-label">
                                        <span class="label-icon">üë®‚Äçüíº</span>
                                        Alex's Role
                                    </label>
                                    <select name="alex_role" class="cosmic-select" required>
                                        <option value="">Select Role...</option>
                                        <option value="electrician">‚ö° Electrician</option>
                                        <option value="plumber">üîß Plumber</option>
                                        <option value="mechanic">üõ†Ô∏è Mechanic</option>
                                    </select>
                                    <div class="select-glow"></div>
                                </div>
                                
                                <div class="form-group cosmic-form-group">
                                    <label class="cosmic-label">
                                        <span class="label-icon">üë©‚Äçüíº</span>
                                        Sam's Role
                                    </label>
                                    <select name="sam_role" class="cosmic-select" required>
                                        <option value="">Select Role...</option>
                                        <option value="electrician">‚ö° Electrician</option>
                                        <option value="plumber">üîß Plumber</option>
                                        <option value="mechanic">üõ†Ô∏è Mechanic</option>
                                    </select>
                                    <div class="select-glow"></div>
                                </div>
                                
                                <div class="form-group cosmic-form-group">
                                    <label class="cosmic-label">
                                        <span class="label-icon">üßë‚Äçüíº</span>
                                        Taylor's Role
                                    </label>
                                    <select name="taylor_role" class="cosmic-select" required>
                                        <option value="">Select Role...</option>
                                        <option value="electrician">‚ö° Electrician</option>
                                        <option value="plumber">üîß Plumber</option>
                                        <option value="mechanic">üõ†Ô∏è Mechanic</option>
                                    </select>
                                    <div class="select-glow"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Submit Button -->
            <div class="puzzle-interface cosmic-interface">
                <div class="button-constellation">
                    <div class="constellation-point btn-point-1"></div>
                    <div class="constellation-point btn-point-2"></div>
                    <div class="constellation-point btn-point-3"></div>
                </div>
                <button type="submit" class="btn-primary solve-btn cosmic-btn">
                    <span class="btn-glow"></span>
                    <span class="btn-icon">üöÄ</span>
                    <span class="btn-text">Activate Systems & Escape!</span>
                    <span class="btn-icon">‚ö°</span>
                </button>
                <div class="interface-tip cosmic-tip">
                    <span class="tip-orb"></span>
                    <span class="tip-icon">üí°</span>
                    <span>Use process of elimination and cross-reference all clues</span>
                </div>
            </div>
        </form>
        
        {% if error %}
        <div class="error-message cosmic-error">
            <div class="error-constellation">
                <div class="constellation-point error-point-1"></div>
                <div class="constellation-point error-point-2"></div>
            </div>
            <span class="error-icon">‚ùå</span>
            <div class="error-content">
                <strong>System Configuration Error!</strong>
                <p>{{ error }}</p>
            </div>
            <div class="retry-hint">
                <span class="retry-orb"></span>
                <span class="retry-icon">üîÑ</span>
                <span>Review the clues and try different combinations</span>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Enhanced Hint Section -->
    <div class="hint-section cosmic-hint">
        <div class="hint-constellation">
            <div class="constellation-point hint-point-1"></div>
            <div class="constellation-point hint-point-2"></div>
            <div class="constellation-point hint-point-3"></div>
        </div>
        <div class="hint-header">
            <span class="hint-main-icon">üîç</span>
            <h4>Logic Solving Strategy</h4>
            <div class="hint-orb"></div>
        </div>
        <div class="hint-content">
            <div class="strategy-constellation">
                <div class="strategy-item">
                    <div class="strategy-orb"></div>
                    <span class="strategy-icon">üéØ</span>
                    <div class="strategy-text">
                        <strong>Start with Direct Clues:</strong> "Sam is the Mechanic" and "Blue System belongs to Electrician"
                    </div>
                </div>
                <div class="strategy-item">
                    <div class="strategy-orb"></div>
                    <span class="strategy-icon">üö´</span>
                    <div class="strategy-text">
                        <strong>Eliminate Possibilities:</strong> Use negative clues to rule out options systematically
                    </div>
                </div>
                <div class="strategy-item">
                    <div class="strategy-orb"></div>
                    <span class="strategy-icon">üîÑ</span>
                    <div class="strategy-text">
                        <strong>Cross-Reference:</strong> Match system colors with technician roles using all clues
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Create control room background
function createControlBackground() {
    const controlBg = document.getElementById('controlBg');
    const nodeCount = 50;
    
    for (let i = 0; i < nodeCount; i++) {
        const node = document.createElement('div');
        node.className = 'control-node';
        
        // Random properties
        const size = Math.random() * 8 + 2;
        const left = Math.random() * 100;
        const top = Math.random() * 100;
        const delay = Math.random() * 5;
        const duration = Math.random() * 3 + 2;
        
        // Color based on position
        const colors = [
            'rgba(255, 0, 0, 0.3)',    // Red
            'rgba(0, 100, 255, 0.3)',  // Blue
            'rgba(0, 255, 100, 0.3)'   // Green
        ];
        const colorIndex = Math.floor(left / 33.3);
        
        node.style.width = `${size}px`;
        node.style.height = `${size}px`;
        node.style.left = `${left}%`;
        node.style.top = `${top}%`;
        node.style.background = colors[colorIndex];
        node.style.animationDelay = `${delay}s`;
        node.style.animationDuration = `${duration}s`;
        
        controlBg.appendChild(node);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    createControlBackground();
    
    const selects = document.querySelectorAll('.cosmic-select');
    const submitBtn = document.querySelector('.cosmic-btn');
    
    // Enhanced selection validation
    selects.forEach(select => {
        select.addEventListener('change', function() {
            validateLogicSelection(this);
            updateButtonState();
        });
        
        // Add focus effects
        select.addEventListener('focus', function() {
            this.parentElement.classList.add('input-focused');
            this.parentElement.querySelector('.select-glow').style.opacity = '1';
        });
        
        select.addEventListener('blur', function() {
            this.parentElement.classList.remove('input-focused');
            this.parentElement.querySelector('.select-glow').style.opacity = '0.3';
        });
    });

    function validateLogicSelection(changedSelect) {
        const allSelects = Array.from(selects);
        const values = allSelects.map(s => s.value).filter(v => v);
        const duplicates = values.filter((value, index) => values.indexOf(value) !== index);
        
        allSelects.forEach(select => {
            const parent = select.parentElement;
            const glow = parent.querySelector('.select-glow');
            
            if (duplicates.includes(select.value) && select.value) {
                select.style.borderColor = '#ff6b6b';
                glow.style.background = 'linear-gradient(45deg, rgba(255, 107, 107, 0.6), rgba(255, 0, 0, 0.3))';
            } else if (select.value) {
                select.style.borderColor = '#4caf50';
                glow.style.background = 'linear-gradient(45deg, rgba(76, 175, 80, 0.6), rgba(0, 255, 100, 0.3))';
            } else {
                select.style.borderColor = '#666';
                glow.style.background = 'linear-gradient(45deg, rgba(74, 144, 226, 0.6), rgba(123, 104, 238, 0.3))';
            }
        });
    }
    
    function updateButtonState() {
        const allFilled = Array.from(selects).every(select => select.value);
        const values = Array.from(selects).map(s => s.value).filter(v => v);
        const noDuplicates = new Set(values).size === values.length;
        
        if (allFilled && noDuplicates) {
            submitBtn.style.background = 'linear-gradient(135deg, #4caf50, #45a049)';
            submitBtn.style.boxShadow = '0 4px 15px rgba(76, 175, 80, 0.4)';
        } else {
            submitBtn.style.background = 'linear-gradient(135deg, rgba(165, 42, 42, 0.9), rgba(205, 92, 92, 0.9))';
            submitBtn.style.boxShadow = '0 4px 15px rgba(165, 42, 42, 0.4)';
        }
    }
    
    // Interactive clue cards
    const clueCards = document.querySelectorAll('.control-clue');
    clueCards.forEach(card => {
        card.addEventListener('click', function() {
            this.classList.toggle('clue-active');
        });
    });
    
    // Initial validation
    validateLogicSelection();
    updateButtonState();
});

// Enhanced animations for control room
const controlStyles = document.createElement('style');
controlStyles.textContent = `
    @keyframes systemPulse {
        0%, 100% { transform: scale(1); opacity: 0.7; }
        50% { transform: scale(1.05); opacity: 1; }
    }
    
    @keyframes glowPulse {
        0%, 100% { box-shadow: 0 0 5px currentColor; }
        50% { box-shadow: 0 0 20px currentColor; }
    }
    
    .red-glow { animation: glowPulse 2s ease-in-out infinite; color: #ff4444; }
    .blue-glow { animation: glowPulse 2s ease-in-out infinite 0.3s; color: #4444ff; }
    .green-glow { animation: glowPulse 2s ease-in-out infinite 0.6s; color: #44ff44; }
    
    .control-clue.clue-active {
        animation: systemPulse 1s ease-in-out;
        border-color: #4a90e2 !important;
    }
    
    .input-focused .cosmic-select {
        transform: scale(1.02);
    }
`;
document.head.appendChild(controlStyles);
</script>

<style>
/* Control Room Specific Styles */
.control-title {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    font-size: 2.5rem;
    background: linear-gradient(135deg, #ff4444, #4444ff, #44ff44);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: titleGlow 3s ease-in-out infinite;
}

@keyframes titleGlow {
    0%, 100% { filter: drop-shadow(0 0 10px rgba(255, 68, 68, 0.5)); }
    33% { filter: drop-shadow(0 0 10px rgba(68, 68, 255, 0.5)); }
    66% { filter: drop-shadow(0 0 10px rgba(68, 255, 68, 0.5)); }
}

.control-glow {
    background: radial-gradient(circle, rgba(74, 144, 226, 0.2), transparent 70%);
}

/* Control Panel Intro */
.control-panel-intro {
    position: relative;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
    padding: 1.5rem;
    border-radius: 15px;
    border: 2px solid rgba(255, 68, 68, 0.3);
    margin-bottom: 1rem;
}

.panel-glow {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at center, rgba(255, 68, 68, 0.1), transparent 50%);
    border-radius: 15px;
    z-index: -1;
}

.urgency-alert {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 1rem;
    background: linear-gradient(135deg, rgba(255, 68, 68, 0.1), rgba(255, 0, 0, 0.05));
    border-radius: 10px;
    border-left: 4px solid #ff4444;
    margin-top: 1rem;
    position: relative;
}

.alert-pulse {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 68, 68, 0.1);
    border-radius: 10px;
    animation: systemPulse 2s ease-in-out infinite;
}

.alert-icon {
    font-size: 1.5rem;
    z-index: 1;
}

.alert-text {
    font-weight: bold;
    color: #ff4444;
    z-index: 1;
}

/* Enhanced Clues Section */
.clues-section {
    margin-bottom: 2rem;
}

.clues-grid {
    display: grid;
    gap: 1rem;
    margin-top: 1.5rem;
}

.clue-card.control-clue {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1.2rem;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.03));
    border: 2px solid rgba(74, 144, 226, 0.3);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}

.clue-card.control-clue:hover {
    transform: translateX(5px);
    border-color: rgba(255, 215, 0, 0.5);
}

.clue-number {
    background: linear-gradient(135deg, #4a90e2, #7b68ee);
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.clue-content p {
    margin: 0;
    color: #f5f5f5;
    line-height: 1.5;
}

.clue-connector {
    position: absolute;
    right: -10px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 2px;
    background: linear-gradient(90deg, #4a90e2, transparent);
    opacity: 0.5;
}

/* Assignment Section */
.assignment-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-top: 1.5rem;
}

.assignment-group {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
    padding: 1.5rem;
    border-radius: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.group-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #ffd700;
    margin-bottom: 1.5rem;
    font-size: 1.2rem;
    border-bottom: 2px solid rgba(255, 215, 0, 0.3);
    padding-bottom: 0.5rem;
}

/* Enhanced Form Elements */
.cosmic-form-group {
    position: relative;
    margin-bottom: 1.5rem;
}

.cosmic-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #ffd700;
    font-weight: bold;
    margin-bottom: 0.8rem;
    font-size: 1rem;
}

.cosmic-select {
    width: 100%;
    padding: 12px 15px;
    font-size: 1rem;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    background: rgba(42, 42, 42, 0.9);
    color: #f5f5f5;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    appearance: none;
    background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%23ffd700' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 12px;
}

.cosmic-select:focus {
    outline: none;
    border-color: #4a90e2;
    box-shadow: 0 0 15px rgba(74, 144, 226, 0.4);
}

.select-glow {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 8px;
    background: linear-gradient(45deg, rgba(74, 144, 226, 0.6), rgba(123, 104, 238, 0.3));
    opacity: 0.3;
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: -1;
}

/* Badges and Counters */
.count-badge, .progress-badge {
    background: linear-gradient(135deg, #ff9800, #ff5722);
    color: white;
    padding: 0.4rem 0.8rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
}

/* Responsive Design */
@media (max-width: 768px) {
    .control-title {
        flex-direction: column;
        font-size: 2rem;
        gap: 0.2rem;
    }
    
    .assignment-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .clue-card.control-clue {
        flex-direction: column;
        text-align: center;
        gap: 0.8rem;
    }
    
    .clue-connector {
        display: none;
    }
}
</style>
{% endblock %}